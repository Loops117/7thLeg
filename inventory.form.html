<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Species - Inventory Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .suggestions { position: absolute; z-index: 1000; background: white; border: 1px solid #ccc; width: 100%; max-height: 200px; overflow-y: auto; }
    .suggestions div { padding: 8px; cursor: pointer; }
    .suggestions div:hover { background: #e9ecef; }
    .section-header { margin-top: 2rem; margin-bottom: 1rem; font-weight: bold; color: #198754; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="text-center mb-4">Add New Species</h2>

    <form id="inventory-form">
      <!-- Identification -->
      <h4 class="section-header">Identification</h4>
      <div class="mb-3 position-relative">
        <label class="form-label">Species</label>
        <input type="text" class="form-control" id="species" name="species" autocomplete="off" required>
        <div id="species-suggestions" class="suggestions d-none"></div>
      </div>
      <div class="mb-3">
        <label class="form-label">Common Name</label>
        <input type="text" class="form-control" id="common_name" name="common_name">
      </div>
      <div class="mb-3">
        <label class="form-label">Insect Type</label>
        <select class="form-select" id="insect_type"></select>
      </div>
      <div class="mb-3">
        <label class="form-label">Cover Photo</label>
        <input type="file" class="form-control" id="cover_image_file" accept="image/*">
      </div>
      <div class="mb-3">
        <label class="form-label">Origin</label>
        <input type="text" class="form-control" id="origin" name="origin">
      </div>
      <div class="mb-3">
        <label class="form-label">Adult Size</label>
        <input type="text" class="form-control" id="adult_size" name="adult_size">
      </div>

      <!-- Accordion -->
      <div class="accordion" id="inventoryAccordion">
        <!-- Acquisition -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acquisitionPanel">
              Acquisition
            </button>
          </h2>
          <div id="acquisitionPanel" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="mb-3">
                <label class="form-label">Date Obtained</label>
                <input type="date" class="form-control" id="date_obtained">
              </div>
              <div class="mb-3">
                <label class="form-label">Source</label>
                <input type="text" class="form-control" id="source">
              </div>
            </div>
          </div>
        </div>

        <!-- Environmental -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#environmentPanel">
              Environmental Needs
            </button>
          </h2>
          <div id="environmentPanel" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="mb-3">
                <label class="form-label">Climate</label>
                <select class="form-select" id="climate"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Humidity</label>
                <select class="form-select" id="humidity"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Hydration Method</label>
                <select class="form-select" id="hydration"></select>
              </div>
            </div>
          </div>
        </div>

        <!-- Enclosure -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#enclosurePanel">
              Enclosure & Habitat
            </button>
          </h2>
          <div id="enclosurePanel" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="mb-3">
                <label class="form-label">Container Type</label>
                <input type="text" class="form-control" id="container_type">
              </div>
              <div class="mb-3">
                <label class="form-label">Ventilation</label>
                <select class="form-select" id="ventilation"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Substrate</label>
                <select class="form-select" id="substrate"></select>
              </div>
            </div>
          </div>
        </div>

        <!-- Feeding -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#feedingPanel">
              Feeding
            </button>
          </h2>
          <div id="feedingPanel" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="mb-3">
                <label class="form-label">Diet</label>
                <select class="form-select" id="diet"></select>
              </div>
            </div>
          </div>
        </div>

        <!-- Status -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#statusPanel">
              Status & Care
            </button>
          </h2>
          <div id="statusPanel" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="status_select"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Care Sheet URL</label>
                <input type="url" class="form-control" id="care_sheet">
              </div>
              <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="notes"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-success w-100 mt-4">Save Entry</button>
      <div id="form-message" class="mt-3 text-center"></div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/config.js"></script>
  <script>
    const supabase = window.supabase;
    const msgEl = document.getElementById("form-message");

    // Prefill date_obtained with today's date
    document.getElementById("date_obtained").value = new Date().toISOString().split("T")[0];

    async function loadOptions(table, selectEl, inputId) {
      const { data: control } = await supabase
        .from("variable_controls")
        .select("is_locked, allow_multi")
        .eq("variable_name", table)
        .single();

      const { data, error } = await supabase.from(table)
        .select("*")
        .order("sort_order", { ascending: true });

      if (error) { console.error(table, error.message); return; }

      selectEl.innerHTML = `<option value="">-- Select --</option>`;
      data.forEach(opt => selectEl.innerHTML += `<option value="${opt.name}">${opt.name}</option>`);

      if (control?.allow_multi) {
        selectEl.setAttribute("multiple", "multiple");
        selectEl.size = Math.min(5, data.length);
      }

      if (control && control.is_locked === false) {
        const customInput = document.createElement("input");
        customInput.type = "text";
        customInput.className = "form-control mt-2";
        customInput.placeholder = "Or type your own value";
        customInput.id = inputId;
        selectEl.parentNode.appendChild(customInput);
      }
    }

    async function resizeImage(file, maxSize = 600) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            let width = img.width, height = img.height;
            if (width > height && width > maxSize) { height *= maxSize / width; width = maxSize; }
            else if (height > maxSize) { width *= maxSize / height; height = maxSize; }
            const canvas = document.createElement("canvas");
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => resolve(blob), "image/jpeg", 0.9);
          };
          img.onerror = (err) => reject(err);
        };
      });
    }

    async function uploadCoverImage(file, speciesName, userId) {
      const timestamp = Date.now();
      const cleanSpecies = speciesName.replace(/\s+/g, '-').toLowerCase();
      const filename = `${userId}/${timestamp}-${cleanSpecies}.jpg`;

      const resizedFile = await resizeImage(file, 600);
      const { error: uploadError } = await supabase.storage
        .from("inventory-images")
        .upload(filename, resizedFile, { upsert: true });

      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabase
        .storage
        .from("inventory-images")
        .getPublicUrl(filename);

      return publicUrl;
    }

    // Load dropdowns
    loadOptions("insect_types", document.getElementById("insect_type"), "insect_type_custom");
    loadOptions("humidity_levels", document.getElementById("humidity"), "humidity_custom");
    loadOptions("climate_types", document.getElementById("climate"), "climate_custom");
    loadOptions("hydration_methods", document.getElementById("hydration"), "hydration_custom");
    loadOptions("ventilation_types", document.getElementById("ventilation"), "ventilation_custom");
    loadOptions("substrate_presets", document.getElementById("substrate"), "substrate_custom");
    loadOptions("diet_presets", document.getElementById("diet"), "diet_custom");
    loadOptions("status_options", document.getElementById("status_select"), "status_custom");

    // Handle form submit
    document.getElementById("inventory-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        msgEl.textContent = "❌ You must be logged in.";
        msgEl.className = "text-danger text-center";
        return;
      }

      // Ensure date_obtained has a value
      const dateInput = document.getElementById("date_obtained");
      if (!dateInput.value) {
        dateInput.value = new Date().toISOString().split("T")[0];
      }

      function getValue(selectId, customId) {
        const sel = document.getElementById(selectId);
        const custom = document.getElementById(customId);

        if (sel && sel.hasAttribute("multiple")) {
          const selected = Array.from(sel.selectedOptions).map(o => o.value);
          if (custom && custom.value.trim()) selected.push(custom.value.trim());
          return selected; // JSON array
        }

        if (custom && custom.value.trim()) return custom.value.trim();
        return sel.value;
      }

      let coverImageUrl = null;
      const coverFile = document.getElementById("cover_image_file").files[0];
      if (coverFile) {
        try {
          coverImageUrl = await uploadCoverImage(coverFile, document.getElementById("species").value, user.id);
        } catch (err) {
          msgEl.textContent = "❌ Image upload failed: " + err.message;
          msgEl.className = "text-danger text-center";
          return;
        }
      }

      const entry = {
        user_id: user.id,
        species: document.getElementById("species").value,
        common_name: document.getElementById("common_name").value,
        insect_type: getValue("insect_type", "insect_type_custom"),
        cover_image: coverImageUrl,
        origin: document.getElementById("origin").value,
        adult_size: document.getElementById("adult_size").value,
        date_obtained: dateInput.value,
        source: document.getElementById("source").value,
        climate: getValue("climate", "climate_custom"),
        humidity: getValue("humidity", "humidity_custom"),
        hydration: getValue("hydration", "hydration_custom"),
        container_type: document.getElementById("container_type").value,
        ventilation: getValue("ventilation", "ventilation_custom"),
        substrate: getValue("substrate", "substrate_custom"),
        diet: getValue("diet", "diet_custom"),
        status: getValue("status_select", "status_custom"),
        care_sheet: document.getElementById("care_sheet").value,
        notes: document.getElementById("notes").value
      };

      const { error } = await supabase.from("user_inventories").insert(entry);
      if (error) {
        msgEl.textContent = "❌ Save failed: " + error.message;
        msgEl.className = "text-danger text-center";
      } else {
        msgEl.textContent = "✅ Entry saved!";
        msgEl.className = "text-success text-center";
        document.getElementById("inventory-form").reset();
        document.getElementById("date_obtained").value = new Date().toISOString().split("T")[0];
      }
    });
  </script>
</body>
</html>
