<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - 7th Leg</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>
  <div id="header"></div>

  <style>
    .dashboard-layout {
      display: flex;
    }

    .dashboard-tabs {
      min-width: 200px;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .dashboard-tabs .nav-link {
      border-radius: 0;
      margin: 0;
      padding: 12px 16px;
      color: #333;
      text-align: left;
    }

    .dashboard-tabs .nav-link.active {
      background-color: #198754;
      color: #fff;
      font-weight: 600;
      width: 100%;
    }

    .dashboard-content {
      flex-grow: 1;
      padding-left: 2rem;
    }

    .highlight-row {
      background-color: #fff3cd !important;
      transition: background-color 1s ease;
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 1rem;
    }
  </style>

  <div class="container py-5">
    <h2 class="text-center mb-4">Dashboard</h2>
    <div class="dashboard-layout">
      <!-- Sidebar Tabs -->
      <ul class="nav flex-column nav-pills dashboard-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active w-100" data-bs-toggle="pill"
            data-bs-target="#profile">Profile</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="pill"
            data-bs-target="#inventory">Inventory</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="pill"
            data-bs-target="#wishlist">Wishlist</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#myauctions">My
            Auctions</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#mytrades">My
            Trades</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#mystore">My
            Store</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="pill"
            data-bs-target="#orders">Orders</button></li>
        <!-- Admin Tabs -->
        <li class="nav-item d-none" id="products-tab-item">
          <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#products">Products</button>
        </li>
        <li class="nav-item d-none" id="categories-tab-item">
          <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#categories">Categories</button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content dashboard-content">
        <div class="tab-pane fade show active" id="profile">Loading...</div>

        <div class="tab-pane fade" id="inventory">
          <div class="toolbar">
            <button class="btn btn-success btn-sm" onclick="openAddSpecies()">âž• Add Species</button>
            <button class="btn btn-outline-primary btn-sm" onclick="copyInventory()">ðŸ“‹ Copy</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="exportInventory()">â¬‡ Export CSV</button>
            <button class="btn btn-outline-info btn-sm" onclick="shareInventory()">ðŸ”— Share</button>
          </div>
          <div id="inventory-table-container">Loading...</div>
        </div>

        <div class="tab-pane fade" id="wishlist">Loading...</div>
        <div class="tab-pane fade" id="myauctions">Loading...</div>
        <div class="tab-pane fade" id="mytrades">Loading...</div>
        <div class="tab-pane fade" id="mystore">Loading...</div>
        <div class="tab-pane fade" id="orders">Loading...</div>
        <div class="tab-pane fade" id="products">Loading...</div>
        <div class="tab-pane fade" id="categories">Loading...</div>

        <!-- Hidden edit tab -->
        <div class="tab-pane fade" id="edit-species">Loading...</div>
      </div>
    </div>
  </div>

  <div id="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/include.js"></script>
  <script src="assets/js/header-auth.js"></script>
  <script>
    const tabMap = {
      profile: "tabs/profile.html",
      inventory: "tabs/inventory.html",
      wishlist: "tabs/wishlist.html",
      myauctions: "tabs/myauctions.html",
      mytrades: "tabs/mytrades.html",
      mystore: "tabs/mystore.html",
      orders: "tabs/orders.html",
      products: "tabs/products.html",
      categories: "tabs/categories.html",
      "edit-species": "tabs/Inventory/edit.species.html"
    };

    // âœ… Loader with event dispatch
    window.loadTabContent = async function (tabId, filePath) {
      const container = document.getElementById(tabId);
      try {
        const response = await fetch(filePath);
        if (!response.ok) throw new Error("Failed to load tab content.");
        container.innerHTML = await response.text();

        let jsFile;
        if (tabId === "edit-species") {
          jsFile = "tabs/Inventory/edit.species.js";
        } else {
          jsFile = `tabs/${tabId}.js`;
        }

        const res = await fetch(jsFile, { method: "HEAD" });
        if (res.ok) {
          await new Promise((resolve) => {
            const script = document.createElement("script");
            script.src = jsFile + "?v=" + Date.now();
            script.onload = resolve;
            script.onerror = resolve;
            document.body.appendChild(script);
          });
        }

        // Fire custom event so listeners can be reattached
        document.dispatchEvent(new Event("tabContentReloaded"));

      } catch (err) {
        container.innerHTML = `<p class="text-danger">${err.message}</p>`;
      }
    };

    // âœ… Central handler
    async function handleTabShown(e) {
      const targetId = e.target.getAttribute('data-bs-target').substring(1);
      if (tabMap[targetId]) {
        await window.loadTabContent(targetId, tabMap[targetId]);
      }
    }

    // âœ… Function to (re)attach listeners
    function attachTabListeners() {
      document.querySelectorAll('#dashboardTabs button[data-bs-toggle="pill"]').forEach(tabBtn => {
        tabBtn.removeEventListener('shown.bs.tab', handleTabShown);
        tabBtn.addEventListener('shown.bs.tab', handleTabShown);
      });
      console.log("âœ… Dashboard tab listeners attached");
    }

    // Attach listeners initially
    attachTabListeners();

    // Reattach after content reloads
    document.addEventListener("tabContentReloaded", attachTabListeners);

    // Load default tab
    window.loadTabContent("profile", tabMap["profile"]);

    // Admin check
    async function loadDashboard() {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) {
        document.querySelector(".container").innerHTML =
          "<div class='alert alert-danger'>You must be logged in to view the dashboard.</div>";
        return;
      }
      const { data: profile } = await window.supabase
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single();

      if (profile?.role === "admin") {
        document.getElementById("products-tab-item").classList.remove("d-none");
        document.getElementById("categories-tab-item").classList.remove("d-none");
      }
    }
    loadDashboard();
  </script>
</body>
</html>
