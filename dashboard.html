<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard - 7th Leg</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/css/style.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; }
    #header, #footer { width: 100%; }
    #header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; z-index: 3000; background: #fff; }
    #footer { position: relative; z-index: 3200; background: #fff; }
    body { padding-top: 100px; }
    #sidebar-wrapper { width: 240px; background: #f8f9fa; border-right: 1px solid #ddd; transition: transform 0.3s ease; z-index: 2000; }
    #sidebar-wrapper { position: fixed; top: 100px; left: -240px; height: calc(100% - 60px); }
    #sidebar-wrapper.open { left: 0; }
    #sidebar-tab { position: fixed; top: 100px; left: 0; background: #198754; color: #fff; padding: 8px 12px; border-top-right-radius: 6px; border-bottom-right-radius: 6px; cursor: pointer; z-index: 3100; }
    #sidebar-wrapper.open + #sidebar-tab { left: 240px; }
    @media (min-width: 768px) {
      #sidebar-wrapper { position: fixed; top: 100px; left: 0; width: 240px; height: calc(100% - 60px); overflow-y: auto; transform: none; z-index: 2500; }
      #sidebar-tab { display: none; }
      #dashboard-main { margin-left: 240px; }
    }
    #dashboard-sidebar { display: flex; flex-direction: column; height: 100%; }
    #dashboard-sidebar .nav-link { color: #333; border-radius: 6px; margin-bottom: 0.4rem; padding: 0.6rem 1rem; font-weight: 500; }
    #dashboard-sidebar .nav-link:hover { background-color: #e9ecef; color: #000; }
    #dashboard-sidebar .nav-link.active { background-color: #198754; color: #fff; }
    #dashboard-content { padding: 1rem; min-height: calc(100vh - 120px); }
  </style>
</head>
<body>
  <div id="header"></div>

  <!-- Sidebar -->
  <div id="sidebar-wrapper">
    <nav id="dashboard-sidebar" class="p-3">
      <ul class="nav flex-column nav-pills" id="dashboardTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active w-100" data-bs-toggle="pill" data-bs-target="#profile">Profile</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#orders">Orders</button></li>
        <li class="nav-item d-none" id="products-tab-item"><button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#products">Products</button></li>
        <li class="nav-item d-none" id="categories-tab-item"><button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#categories">Categories</button></li>
      </ul>
    </nav>
  </div>

  <div id="sidebar-tab">â˜°</div>

  <!-- Main Content -->
  <div id="dashboard-main">
    <div class="tab-content" id="dashboard-content">
      <div class="tab-pane fade show active" id="profile">Loading...</div>
      <div class="tab-pane fade" id="orders">Loading...</div>
      <div class="tab-pane fade" id="products">Loading...</div>
      <div class="tab-pane fade" id="categories">Loading...</div>
    </div>
  </div>

  <div id="footer"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/include.js"></script>
  <script src="assets/js/header-auth.js"></script>

  <script>
    // Map only the kept tabs
    const tabMap = {
      profile: "tabs/profile.html",
      orders: "tabs/orders.html",
      products: "tabs/products.html",
      categories: "tabs/categories.html"
    };

    window.loadTabContent = async function (tabId, filePath) {
      const container = document.getElementById(tabId);
      try {
        const response = await fetch(filePath);
        if (!response.ok) throw new Error("Failed to load tab content.");
        container.innerHTML = await response.text();

        let jsFile = `tabs/${tabId}.js`;
        jsFile += `?v=${Date.now()}`;
        const script = document.createElement("script");
        script.src = jsFile;
        script.onload = () => {
          console.log(`ðŸ“Œ Reloaded script for ${tabId}`);
          const fnName = "init" + tabId.charAt(0).toUpperCase() + tabId.slice(1);
          if (typeof window[fnName] === "function") {
            console.log(`ðŸ“Œ Running ${fnName}()`);
            window[fnName]();
          }
        };
        document.body.appendChild(script);

        attachTabListeners();
      } catch (err) {
        container.innerHTML = `<p class="text-danger">${err.message}</p>`;
      }
    };

    function handleTabShown(e) {
      const targetId = e.target.getAttribute('data-bs-target').substring(1);
      if (tabMap[targetId]) {
        window.loadTabContent(targetId, tabMap[targetId]);
      }
    }

    function attachTabListeners() {
      document.querySelectorAll('#dashboardTabs button[data-bs-toggle="pill"]').forEach(tabBtn => {
        tabBtn.removeEventListener('shown.bs.tab', handleTabShown);
        tabBtn.addEventListener('shown.bs.tab', handleTabShown);
      });
      console.log("âœ… Dashboard tab listeners reattached");
    }

    attachTabListeners();
    window.loadTabContent("profile", tabMap["profile"]);

    async function loadDashboard() {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) {
        document.querySelector("#dashboard-main").innerHTML =
          "<div class='alert alert-danger'>You must be logged in to view the dashboard.</div>";
        return;
      }

      const { data: profile } = await window.supabase
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single();

      if (profile?.role === "admin") {
        document.getElementById("products-tab-item").classList.remove("d-none");
        document.getElementById("categories-tab-item").classList.remove("d-none");
      }
    }
    loadDashboard();

    // Mobile toggle
    const sidebarTab = document.getElementById("sidebar-tab");
    const sidebarWrapper = document.getElementById("sidebar-wrapper");
    sidebarTab.addEventListener("click", () => {
      sidebarWrapper.classList.toggle("open");
    });
    document.addEventListener("click", (e) => {
      if (
        sidebarWrapper.classList.contains("open") &&
        !sidebarWrapper.contains(e.target) &&
        !sidebarTab.contains(e.target)
      ) {
        sidebarWrapper.classList.remove("open");
      }
    });
  </script>
</body>
</html>
